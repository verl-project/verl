name: VERL-CI-TAS

on:
  workflow_dispatch:
  push:
    branches:
      - dev
  pull_request:


jobs:
  build-docker:
    runs-on: build-verl-docker
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - run: echo "ðŸŽ‰ Begin Build Verl Docker Image."
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Show Environment Info
        run: |
          echo "Hostname: $(hostname)"
          echo "PWD: $(pwd)"
          echo "HOME: $HOME"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "Runner Temp Dir: $RUNNER_TEMP"
          echo "Runner Tool Cache: $RUNNER_TOOL_CACHE"
      - name: Parse Commit Info
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "IMAGE_TAG=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME="${{ github.ref }}"
            TAG="${TAG_NAME#refs/tags/}"
            echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=others" >> $GITHUB_ENV
          fi
      - name: Build and Push Docker Image
        run: |
          echo "> Login to ROCm Docker Hub"
          docker login -u rocmshared -p ${{ secrets.ROCM_DOCKER_HUB_TOKEN }}

          # echo "> Build Docker Image with tag: ${{ env.IMAGE_TAG }}"
          # start_time=$(date +%s)
          # docker build --network=host \
          #      -f $GITHUB_WORKSPACE/.github/workflows/docker/Dockerfile \
          #      -t tasimage/primus:verl-${{env.IMAGE_TAG}} \
          #      $GITHUB_WORKSPACE/.github/workflows/docker
          # end_time=$(date +%s)
          # elapsed=$((end_time - start_time))
          # echo "â±ï¸ [build verl docker] Total elapsed time: ${elapsed} seconds"
          
          echo "> Build ROCM7 Torch2.9 Docker Image with tag: ${{ env.IMAGE_TAG }}"
          start_time=$(date +%s)
          docker build --network=host \
               -f $GITHUB_WORKSPACE/.github/workflows/docker/Dockerfile.torch2.9 \
               -t tasimage/primus:verl-torch2.9-${{env.IMAGE_TAG}} \
               $GITHUB_WORKSPACE/.github/workflows/docker
          end_time=$(date +%s)
          elapsed=$((end_time - start_time))
          echo "â±ï¸ [build verl docker] Total elapsed time: ${elapsed} seconds"

          echo "> Login to Primus Docker Hub"
          docker login -u tasimage -p ${{ secrets.PRIMUS_DOCKER_HUB_TOKEN }}

          echo "> Docker push to Docker Hub"
          start_time=$(date +%s)
          # docker push docker.io/tasimage/primus:verl-${{env.IMAGE_TAG}}
          docker push docker.io/tasimage/primus:verl-torch2.9-${{env.IMAGE_TAG}}
          end_time=$(date +%s)
          elapsed=$((end_time - start_time))
          echo "â±ï¸ [push primus docker] Total elapsed time: ${elapsed} seconds"

          # echo "> Docker cleanup local images"
          # docker rmi tasimage/primus:${{env.IMAGE_TAG}}
          # echo "> build-docker success"
